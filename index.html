<!DOCTYPE html>
<html>

<head>
  <title>INFO 4310 HW4</title>
  <link rel="stylesheet" type="text/css" href="styles.css">
  <script src="https://d3js.org/d3.v4.min.js"></script>
</head>

<body>
  <div>
    <svg id="map_svg" />

    <div id="pinDiv">
      <b> Pinned Places </b>
      <!-- TODO: Delete before final submission-->
      <div class="pinned">
        <title> SAMPLE: Wheelhouse </title>
        <addr> 63 Broad St, Financial District, Boston, MA 02109 </addr>
        <hr>
        <cats> Breakfast & Brunch, Burgers, Sandwiches</cats>
        <rating> 4.5 </rating>
        <snippet> After going to Wheelhouse, you'll never order a Dunkin Donuts' breakfast sandwich ever again. Well, you might, but you won't enjoy it. This place has the...</snippet>
      </div>
    </div>
  </div>
</body>

<script>
  var width = 800;
  var height = 600;

  const radius = 5;

  var svg = d3.select("#map_svg")
    .attr("width", width)
    .attr("height", height);

  var g = svg.append("g");

  var tooltip = d3.select("body")
    .append("div")
    .attr("class", "tooltip");

  var projection = d3.geoMercator()
    .center([-71.0589, 42.3201])
    .scale(150000)
    .translate([width / 2, height / 2]);

  const geopath = d3.geoPath()
    .projection(projection);

  // TODO: Replace this with some nice graphic or icon
  svg.append("text")
    .attr("x", 50)
    .attr("y", 50)
    .style("stroke", "black")
    .text("Pan & Zoom to explore")

  d3.queue()
    .defer(d3.csv, "data/yelp_cats_boston.fixed.csv")
    .defer(d3.json, "data/boston.geojson")
    .await(makeViz);

  function makeViz(error, restaurants, geojson) {

    // To filter out. Only including restaurants representable in Boston proper
    noneOf = ["", "Coolidge Corner", "Harvard Square", "Teele Square",
      "Inman Square", "Kendall Square/MIT", "Porter Square", "North Cambridge"
    ]

    // Filter reduces restaurant numbers from 343 to 254
    restaurants = restaurants.filter(d => noneOf.indexOf(d.neighborhood) == -1);

    restaurants.forEach(function(d) {
      d["rating"] = Number(d["rating"]);
      d["review count"] = Number(d["review count"]);
      d["longitude"] = Number(d["longitude"]);
      d["latitude"] = Number(d["latitude"]);
      d["location"] = JSON.parse(d["location"]);
      d["categories"] = JSON.parse(d["categories"]).map(x => x[0]);
      [d["x_proj"], d["y_proj"]] = projection([d.longitude, d.latitude]);
    });

    // Pan and Zoom Actions
    svg.call(d3.zoom()
      .scaleExtent([1, 20]) // [x-times out-zoom, x-times in-zoom]
      .on("zoom", function() {

        var scale = 1;
        var scalere = /scale\((\d.*\d*)+\)/

        // TODO: TEST CODE TO REMOVE?
        if (g.attr("transform") == null) {
          scale = 1;
        } else {
          rawScaleString = g.attr("transform").split(" ")[1];
          scale = Number(scalere.exec(rawScaleString)[1]);
        }
        g.attr("transform", d3.event.transform)

        // TODO: may want to remove?
        g.selectAll("circle")
          .attr("r", radius / scale);
        g.selectAll(".polygons")
          .style("stroke-width", 1 / scale);
      }));

    g.selectAll(".district")
      .data(geojson.features)
      .enter()
      .append("path")
      .attr("stroke", "black")
      .attr("fill", (d, i) => "#ccc")
      .attr("class", "district")
      .attr("d", geopath);

    var voronoi = d3.voronoi()
      .extent([[-1, -1],[width + 1, height + 1]]);

    var sites = restaurants.map(d => [d.x_proj, d.y_proj]);

    g.append("g")
      .attr("class", "polygons")
      .selectAll("path")
      .data(voronoi.polygons(sites))
      .enter()
      .append("path")
      .call(redrawPolygon);

    // g.append('g')
    //   .attr("class", "links")
    //   .selectAll("line")
    //   .data(voronoi.links(sites))
    //   .enter().append("line")
    //   .call(redrawLink);


    g.selectAll("circle")
      .data(restaurants).enter()
      .append("circle")
      .attr("cx", d => d.x_proj)
      .attr("cy", d => d.y_proj)
      .attr("r", radius)
      .style("fill", "red")
      .style("opacity", 0.6)
      .on("mouseover", mouseoverActions)
      .on("mouseout", mouseoutActions)
      .on("click", clickActions)

    function mouseoverActions(d) {

      tooltip
        .html(d.name)
        .style("display", "block")
        .style("left", d3.event.clientX + "px")
        .style("top", d3.event.clientY + "px");
    }

    function mouseoutActions(d) {
      tooltip
        .style("display", "none");
    }

    function clickActions(d) {
      console.log(d);
      d3.select("#pinDiv")
        .html(d3.select("#pinDiv").html() + makePinnable(d));
    }

    console.log(restaurants);
    console.log(geojson);

    function makePinnable(d) {
      return `
      <div class="pinned">
        <title> ${d.name} </title>
        <addr> ${d.location.display_address.reduce( (a,b) => a+", "+b)} </addr>
        <hr>
        <cats> ${d.categories.reduce( (a,b) => a+", "+b)} </cats>
        <rating> ${d.rating} </rating>
        <snippet> ${d.snippet_text} </snippet>
      </div>
      `
    }

    // This function is from: https://bl.ocks.org/mbostock/4060366
    function redrawPolygon(polygon) {
      polygon
        .attr("d", function(d) {
          return d ? "M" + d.join("L") + "Z" : null;
        });
    }

    function redrawLink(link) {
      link
        .attr("x1", function(d) {
          return d.source[0];
        })
        .attr("y1", function(d) {
          return d.source[1];
        })
        .attr("x2", function(d) {
          return d.target[0];
        })
        .attr("y2", function(d) {
          return d.target[1];
        });
    }


  }
</script>


</html>
