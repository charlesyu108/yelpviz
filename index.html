<!DOCTYPE html>
<html>

<head>
  <title>INFO 4310 HW4</title>
  <link rel="stylesheet" type="text/css" href="styles.css">
  <script src="https://d3js.org/d3.v4.min.js"></script>
</head>

<body>
  <div>
    <svg id="map_svg" />
    <div id="pinDiv">
      <div id = "pinDivHeader">
         <b> Pinned Places </b> <span id = "pinnedCount"> (0) </span>
       </div>

      <!-- TODO: Delete before final submission-->
      <div class ="pinnedInfo">
        <button onclick = "deleteDiv(this)"> x </button>
      <div class="pinned">
        <div class="info">
          <title> SAMPLE: Wheelhouse </title>
          <addr> 63 Broad St, Boston, MA 02109 </addr>
          <hr>
          <cats> Breakfast & Brunch, Burgers, Sandwiches</cats>
          <rating> 4.5 </rating>
          <snippet> After going to Wheelhouse, you'll never order a Dunkin Donuts' breakfast sandwich ever again. Well, you might, but you won't enjoy it. This place has the...</snippet>
        </div>
      </div>
    </div>
    <!-- TODO: Delete before final submission-->
  </div>
    <button id="test"> jiggle </button>
  </div>
</body>

<script>
  var width = 800;
  var height = 600;

  const radius = 7;
  const districtLabelFontSz = 20;

  var svg = d3.select("#map_svg")
    .attr("width", width)
    .attr("height", height);

  var g = svg.append("g");

  var tooltip = d3.select("body")
    .append("div")
    .attr("class", "tooltip");

  var projection = d3.geoMercator()
    .center([-71.0589, 42.3201])
    .scale(150000)
    .translate([width / 2, height / 2]);

  const geopath = d3.geoPath()
    .projection(projection);

  // TODO: Replace this with some nice graphic or icon
  svg.append("text")
    .attr("x", 50)
    .attr("y", 50)
    .text("Pan & Zoom to explore")

  var zoomlbl = svg.append("text")
    .attr("x", 210)
    .attr("y", 50)
    .text("100%")

  d3.queue()
    .defer(d3.csv, "data/yelp_cats_boston.fixed.csv")
    .defer(d3.json, "data/boston.geojson")
    .await(makeViz);

  function makeViz(error, restaurants, geojson) {

    // To filter out. Only including restaurants representable in Boston proper
    noneOf = ["", "Coolidge Corner", "Harvard Square", "Teele Square",
      "Inman Square", "Kendall Square/MIT", "Porter Square", "North Cambridge"
    ]

    // Filter reduces restaurant numbers from 343 to 254
    restaurants = restaurants.filter(d => noneOf.indexOf(d.neighborhood) == -1);

    // Cleaning up the raw data
    restaurants.forEach(function(d) {
      d["rating"] = Number(d["rating"]);
      d["review_count"] = Number(d["review_count"]);
      d["longitude"] = Number(d["longitude"]);
      d["latitude"] = Number(d["latitude"]);
      d["location"] = JSON.parse(d["location"]);
      d["categories"] = JSON.parse(d["categories"]).map(x => x[0]);
      [d["x_proj"], d["y_proj"]] = projection([d.longitude, d.latitude]);
      delete d["search category"];
    });

    // Removing duplicate entries - reduces from 254 to 212
    var uniqueRestaurants = [];
    restaurants.forEach(function(d) {
      var conflicts = uniqueRestaurants.filter(x => (x.name == d.name && x.latitude == d.latitude && x.longitude == d.longitude))
      if (conflicts.length == 0) {
        uniqueRestaurants.push(d);
      }
    });
    restaurants = uniqueRestaurants;

    // Assigning voronoi regions for each restaurant
    var voronoi = d3.voronoi()
      .extent([
        [-1, -1],
        [width + 1, height + 1]
      ]);
    var polygons = voronoi.polygons(restaurants.map(d => [d.x_proj, d.y_proj]));
    restaurants.forEach((d, i) => d["voronoi"] = polygons[i]);

    // Scale factor of zoom
    var scale = 1;

    // Pan and Zoom Actions
    svg.call(d3.zoom()
      .scaleExtent([1, 30]) // [x-times out-zoom, x-times in-zoom]
      .on("zoom", function() {

        var scalere = /scale\((\d.*\d*)+\)/

        // TODO: TEST CODE TO REMOVE?
        if (g.attr("transform") == null) {
          scale = 1;
        } else {
          rawScaleString = g.attr("transform").split(" ")[1];
          scale = Number(scalere.exec(rawScaleString)[1]);
        }
        g.attr("transform", d3.event.transform)

        // TODO: may want to remove?
        g.selectAll("circle")
          .attr("r", radius / scale);

        g.selectAll("path")
          .style("stroke-width", 1 / scale);

        g.selectAll(".districtLabel")
          .style("font-size", districtLabelFontSz / scale);

        zoomlbl.text(Math.round(scale * 100) + "%");

      }));

    // TODO delete? Jiggle button effect
    d3.select("#test").on("click", function() {
      g.selectAll("circle")
        .attr("cx", (x => Math.random() * radius / scale + x.x_proj))
        .attr("cy", (x => Math.random() * radius / scale + x.y_proj));
    });

    var districts = g.selectAll(".district")
      .data(geojson.features)
      .enter()
      .append("path")
      .attr("stroke", "black")
      .attr("fill", (d, i) => "#ccc")
      .attr("class", "district")
      .attr("d", geopath);

    console.log(d3.selectAll(".district"));

    g.selectAll(".districtLabel")
      .data(geojson.features)
      .enter()
      .append("text")
      .attr("x", d => geopath.centroid(d)[0])
      .attr("y", d => geopath.centroid(d)[1])
      .text(d => d.properties.name)
      .attr("class", "districtLabel")
      .style("font-size", districtLabelFontSz);

    // var color = d3.scaleOrdinal(d3.schemeCategory20);
    // g.append("g")
    //   .attr("class", "polygons")
    //   .selectAll("path")
    //   .data(restaurants)
    //   .enter()
    //   .append("path")
    //   .style("opacity", 0.3)
    //   .style("fill", (d,i) => color(i))
    //   .call(drawPolygon);

    g.selectAll("circle")
      .data(restaurants).enter()
      .append("circle")
      .attr("class", "restaurant")
      .attr("cx", d => d.x_proj)
      .attr("cy", d => d.y_proj)
      .attr("r", radius)
      .on("mouseover", mouseoverActions)
      .on("mouseout", mouseoutActions)
      .on("click", clickActions)

    function mouseoverActions(d) {

      tooltip
        .html(makeInfo(d))
        .style("display", "block")
        .style("left", d3.event.clientX + "px")
        .style("top", d3.event.clientY + "px");
    }

    function mouseoutActions(d) {
      tooltip
        .style("display", "none");
    }

    function clickActions(d) {
      console.log(d);
      d3.select("#pinDiv")
        .html(d3.select("#pinDiv").html() + makePinnedInfo(d));
      d3.select("#pinnedCount")
      .html("(" + (document.getElementById("pinDiv").children.length - 1) + ")");
    }

    console.log(restaurants);
    console.log(geojson);

    function makeInfo(d) {
      return `
      <div class="info">
        <title> ${d.name} </title>
        <addr> ${d.location.display_address.reduce( (a,b) => a+", "+b)} </addr>
        <hr>
        <cats> ${d.categories.reduce( (a,b) => a+", "+b)} </cats>
        <rating> ${d.rating} </rating>
        <snippet> ${d.snippet_text} </snippet>
      </div>
      `
    }

    function makePinnedInfo(d){
      return `
      <div class = "pinnedInfo">
        <button onclick="deleteDiv(this)"> x </button>
        ${makeInfo(d)}
      </div>
      `
    }

    // This function is from: https://bl.ocks.org/mbostock/4060366
    function drawPolygon(polygon) {
      console.log(polygon);
      polygon
        .attr("d", function(d) {
          return d.voronoi ? "M" + d.voronoi.join("L") + "Z" : null;
        });
    }
  }

  function deleteDiv(button){
    d3.select(button.parentNode).remove();
    d3.select("#pinnedCount")
    .html("(" + (document.getElementById("pinDiv").children.length - 1) + ")");
  }


</script>


</html>
